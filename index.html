<!doctype html>
<html lang="ko">
<meta charset="utf-8" />
<title>UNO R4 WiFi Relay Remote</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<style>
  body{font-family:system-ui,Segoe UI,Roboto,sans-serif;margin:0;background:#f6f7fb}
  .wrap{max-width:560px;margin:40px auto;padding:20px}
  .card{background:#fff;border-radius:14px;box-shadow:0 6px 24px rgba(0,0,0,.06);padding:22px}
  h1{font-size:22px;margin:0 0 10px}
  .line{margin:6px 0;color:#666}
  .ok{color:#1f9d55;font-weight:700}.bad{color:#c23}
  .btns{display:flex;gap:10px;margin-top:10px}
  button{flex:1;padding:14px 16px;border:0;border-radius:10px;font-size:18px;cursor:pointer}
  .on{background:#10b981;color:#fff}.off{background:#ef4444;color:#fff}.tg{background:#3b82f6;color:#fff}
  .foot{margin-top:10px;font-size:12px;color:#888}
  pre{background:#0b1020;color:#cde3ff;border-radius:10px;padding:10px;max-height:160px;overflow:auto}
</style>

<div class="wrap">
  <div class="card">
    <h1>UNO R4 WiFi – 릴레이(Relay) 원격 제어</h1>

    <div class="line">브로커: <code id="broker"></code></div>
    <div class="line">브라우저↔브로커: <span id="brokerConn" class="bad">연결 안됨</span></div>
    <div class="line">장치(UNO) 상태: <span id="conn" class="bad">연결 안됨</span></div>

    <div class="line">릴레이 상태: <b id="state">알 수 없음</b></div>
    <div class="btns">
      <button class="on"  onclick="send('ON')">켜기</button>
      <button class="off" onclick="send('OFF')">끄기</button>
      <button class="tg"  onclick="send('TOGGLE')">토글</button>
    </div>
    <div class="foot">토픽 프리픽스: <code id="pref"></code></div>
  </div>
  <pre id="log"></pre>
</div>

<script>
  // === 본인 값 입력 ===
  const HOST   = "wss://ffcf6bab.ala.asia-southeast1.emqxsl.com:8084/mqtt";
  const USER   = "ljw8866";
  const PASS   = "@011266Aab";
  const PREFIX = "ledtest";

  document.getElementById('broker').textContent = HOST;
  document.getElementById('pref').textContent   = PREFIX;

  const topicCmd   = `${PREFIX}/led/cmd`;
  const topicState = `${PREFIX}/led/state`;
  const topicHB    = `${PREFIX}/sys/hb`;       // ★ 하트비트(heartbeat) 토픽

  const logEl   = document.getElementById('log');
  const stateEl = document.getElementById('state');
  const connEl  = document.getElementById('conn');        // 장치(UNO) 상태
  const brkEl   = document.getElementById('brokerConn');  // 브라우저↔브로커 상태

  function log(...a){ logEl.textContent += a.join(' ')+"\n"; logEl.scrollTop = logEl.scrollHeight }
  function setBrk(ok){ brkEl.textContent = ok?'연결됨':'연결 안됨'; brkEl.className = ok?'ok':'bad'; }
  function setDev(ok){ connEl.textContent = ok?'연결됨':'연결 안됨'; connEl.className = ok?'ok':'bad'; }

  // 하트비트 타임아웃(UNO 오프라인 판정)
  const OFFLINE_AFTER_MS = 12000; // 12초 동안 하트비트 없으면 오프라인
  let lastHb = 0;
  setInterval(() => {
    if (!lastHb) return;
    if (Date.now() - lastHb > OFFLINE_AFTER_MS) setDev(false);
  }, 1000);

  const client = mqtt.connect(HOST, {
    clientId: "web-"+Math.random().toString(16).slice(2),
    username: USER, password: PASS, keepalive: 60, clean: true,
  });

  client.on('connect', () => {
    setBrk(true);
    log('[connect] ok');
    client.subscribe([topicState, topicHB], (err)=> err?log('[sub err]',err):log('[sub]', topicState, topicHB));
  });

  client.on('message', (t,p) => {
    const s = new TextDecoder().decode(p).trim();
    log('[msg]', t, '→', s);

    if (t===topicState) {
      stateEl.textContent = s;
    } else if (t===topicHB) {
      lastHb = Date.now();
      setDev(true);  // 하트비트 받으면 장치 온라인
    }
  });

  client.on('reconnect', ()=>{ log('[reconnect]'); setBrk(false); setDev(false); });
  client.on('offline',   ()=>{ log('[offline]');   setBrk(false); setDev(false); });
  client.on('close',     ()=>{ log('[close]');     setBrk(false); setDev(false); });
  client.on('error',  e=>{ log('[error]', e?.message||e); setBrk(false); setDev(false); });

  function send(cmd){
    client.publish(topicCmd, cmd/*, { qos:1 }*/);
    log('[pub]', topicCmd, '←', cmd);
  }
</script>
</html>
